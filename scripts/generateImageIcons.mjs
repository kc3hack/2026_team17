import "dotenv/config";
import fs from "node:fs";
import path from "node:path";
import OpenAI from "openai";

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

const FOODS = [
"牡蠣", 
"ラーメン", 
"イカ", 
"海鮮丼", 
"寿司", 
"ジンギスカン", 
"ちゃんちゃん焼き", 
"石狩鍋",
"カニ",
"ホタテ",
"ウニ",
"いくら",
"ザンギ",
"焼き鳥",
"海鮮炉端焼き",
"ホルモン",
"豚丼",
"昆布",
"海鮮",
"カレー",
"焼肉",
"スパカツ",
"あげいも",
"カレーそば",
"焼きそば",
"マグロ",
"せんべい汁",
"貝焼き味噌",
"いちご煮",
"バラ焼き",
"けの汁",
"しじみ貝焼き",
"そば",
"冷麵",
"じゃじゃ麵",
"牛料理",
"瓶ドン",
"ジンギスカン",
"海鮮丼",
"ウニ丼",
"サンマ",
"ひっつみ汁",
"牛タン",
"牛料理",
"ずんだ餅",
"はらこ飯",
"サバ料理",
"フカヒレ料理",
"寿司",
"カツオ料理",
"笹かまぼこ",
"温麺",
"きりたんぽ鍋",
"うどん",
"比内地鶏料理",
"男鹿ハタハタ料理",
"鍋",
"芋煮",
"冷やしラーメン",
"どんどん焼き",
"酒田ワンタン面",
"米沢コロッケ",
"玉こんにゃく",
"鳥中華",
"カツ丼",
"餃子",
"会津こづゆ",
"いかにんじん",
"馬刺し",
"あんこう鍋",
"納豆料理",
"常陸秋そば",
"しらす丼",
"はまぐり料理",
"しらすピザ",
"しゃも料理",
"レモン牛乳",
"那須高原ステーキ",
"那須高原チーズ料理",
"湯葉料理",
"焼きまんじゅう",
"高崎パスタ",
"草津温泉湯もみ料理",
"上州もつ煮",
"焼うどん",
"ゼリーフライ",
"味噌ポテト",
"豚みそ丼",
"行田フライ",
"草加せんべい",
"うなぎ",
"なめろう",
"さんが焼き",
"伊勢海老料理",
"金目鯛料理",
"銚子つりきんめどん",
"房総アジフライ",
"もんじゃ焼き",
"深川めし",
"天ぷら",
"あさり料理",
"下町天丼",
"横浜ナポリタン",
"しらす丼",
"のっぺ",
"南蛮エビ丼",
"白エビ丼",
"ホタルイカ料理",
"寒ブリ料理",
"カニ料理",
"おでん",
"のどぐろ料理",
"治部煮",
"ふぐ料理",
"加賀料理",
"焼き鯖寿司",
"ほうとう",
"鳥もつ煮",
"山賊焼き",
"おやき",
"サーモン料理",
"野沢菜料理",
"野沢菜温泉料理",
"鶏ちゃん料理",
"朴葉味噌",
"けいちゃん焼き",
"桜えび料理",
"金目鯛",
"カツオ",
"げんこつハンバーグ",
"ひつまぶし",
"味噌カツ",
"手羽先",
"きしめん",
"あんかけスパ",
"牡蠣料理",
"えび料理",
"ブリ料理",
"マグロ料理",
"鮒ずし",
"近江ちゃんぽん",
"近江牛すき焼き",
"焼鯖そうめん",
"湯豆腐",
"鴨料理",
"京懐石",
"鯖寿司",
"鱧料理",
"抹茶",
"たこ焼き",
"お好み焼き",
"串カツ",
"イカ焼き",
"肉吸い",
"明石焼き",
"ぼっかけ",
"玉ねぎ料理",
"鯛料理",
"そうめん",
"奈良茶粥",
"大和肉鶏料理",
"クエ料理",
"鯛",
"梅とんかつ",
"ホルモンうどん",
"日生カキオコ",
"津山そずり鍋",
"広島風お好み焼き",
"穴子飯",
"汁なし担々麵",
"つけ麵",
"瓦そば",
"砂丘らっきょう料理",
"白イカ料理",
"しじみ汁",
"宍道湖七珍料理",
"浜田赤天",
"骨付鳥",
"徳島フィッシュカツ",
"焼豚玉子飯",
"じゃこ天",
"鯛めし",
"もつ鍋",
"水炊き",
"焼きラーメン",
"明太子料理",
"ちゃんぽん",
"佐世保バーガー",
"トルコライス",
"ヒラメ料理",
"穴子料理",
"馬刺し",
"太平燕",
"からし蓮根",
"天草大王料理",
"とり天",
"だんご汁",
"地獄蒸し料理",
"宇佐唐揚げ",
"チキン南蛮",
"地鶏炭火焼",
"冷や汁",
"宮崎辛麵",
"辛麺",
"うなまぶし",
"黒豚料理",
"白熊デザート",
"鶏飯",
"さつま揚げ",
"きびなご料理",
"黒薩摩鶏料理",
"沖縄そば",
"ゴーヤチャンプルー",
"ラフテー",
"アグー豚料理",
"宮古ヤギ汁",
"沖縄天ぷら",
"しょっつる鍋",
"キムチ鍋",
"台湾ラーメン",
"カレーうどん",
"味噌煮込みうどん",
"にしんそば",
"柿の葉寿司",
"昆布料理",
"ラーメンサラダ",
"あんかけ焼きそば",
"わんこそば",
"へきそば",
"タレかつ丼",
"ます寿司",
"柿の葉寿司",
];

// 1) 前後空白除去 + 空除外 + 重複排除（順序維持）
const foods = Array.from(
  new Set(FOODS.map(s => (s ?? "").trim()).filter(Boolean))
);

// 2) Windowsで安全なファイル名にする（最低限）
function safeFileName(name) {
  return name
    .replace(/[\\/:*?"<>|]/g, " ") // 禁止文字を空白へ
    .replace(/\s+/g, " ")          // 連続空白をまとめる
    .trim();
}

const OUT_DIR = path.join(process.cwd(), "public", "icons", "food");
fs.mkdirSync(OUT_DIR, { recursive: true });

for (const food of foods) {
  const fileName = `${safeFileName(food)}.png`;
  const outPath = path.join(OUT_DIR, fileName);

  if (fs.existsSync(outPath)) {
    console.log(`Skip: ${fileName}`);
    continue;
  }

  console.log(`Generating: ${food}`);

  const prompt = `日本地図に載せるための食べ物アイコン。
「${food}」をモチーフにした、シンプルなモノクロのピクトグラム。
影なし、文字なし、余白多め、中心配置、透過背景。`;

  try {
    const img = await openai.images.generate({
      model: "gpt-image-1.5",
      prompt,
      size: "1024x1024",
      background: "transparent",
      output_format: "png",
    });

    const b64 = img.data?.[0]?.b64_json;
    if (!b64) {
      console.log(`Failed (no b64): ${food}`);
      continue;
    }

    fs.writeFileSync(outPath, Buffer.from(b64, "base64"));
    console.log(`Saved: ${fileName}`);
  } catch (e) {
    console.log(`Failed (error): ${food}`);
    console.log(e?.message ?? e);
    // 落ちずに次へ
  }
}

console.log(`Done. total unique foods = ${foods.length}`);